<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Trip 2026</title>
    
    <!-- iOS PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Trip 2026">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/201/201623.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media',
            theme: {
                extend: {
                    padding: { 
                        'safe-top': 'env(safe-area-inset-top)', 
                        'safe-bottom': 'env(safe-area-inset-bottom)' 
                    },
                    margin: { 
                        'safe-bottom': 'env(safe-area-inset-bottom)' 
                    },
                    spacing: {
                        'safe-bottom': 'env(safe-area-inset-bottom)'
                    }
                }
            }
        }
    </script>

    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { 
            -webkit-tap-highlight-color: transparent; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif; 
            background-color: #F2F2F7;
            /* ç¢ºä¿èƒŒæ™¯è‰²å»¶ä¼¸åˆ°å…¨è¢å¹• */
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }
        @media (prefers-color-scheme: dark) {
            body { background-color: #000000; }
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        
        /* Accordion transition */
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1); }
        .accordion-content.open { max-height: 2500px; transition: max-height 0.5s ease-in; }
        .rotate-icon { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .rotate-icon.open { transform: rotate(90deg); }
        
        /* Apple UI List Group Style */
        .apple-list-group {
            background-color: white;
            border-radius: 22px;
            overflow: hidden;
        }
        .dark .apple-list-group {
            background-color: #1C1C1E;
        }
        .apple-list-item {
            border-bottom: 0.5px solid rgba(0,0,0,0.1);
        }
        .dark .apple-list-item {
            border-bottom: 0.5px solid rgba(255,255,255,0.1);
        }
        .apple-list-item:last-child { border-bottom: none; }

        @media (prefers-color-scheme: dark) {
            iframe.map-frame { filter: invert(90%) hue-rotate(180deg); }
        }
        
        /* Safe Area Utilities */
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-pb-with-margin { padding-bottom: calc(1.5rem + env(safe-area-inset-bottom)); }
        .safe-bottom-pos { bottom: calc(1.5rem + env(safe-area-inset-bottom)); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Data ---
        const CITY_COORDS = { 'Taipei': {lat:25.033,lng:121.565}, 'Paris': {lat:48.856,lng:2.352}, 'Malta': {lat:35.937,lng:14.375}, 'Venice': {lat:45.440,lng:12.315}, 'Florence': {lat:43.769,lng:11.255}, 'Rome': {lat:41.902,lng:12.496} };

        const TRIP = [
            { id:'d0', date:'1/31', wk:'é€±å…­', city:'Taipei', t:'20Â°', c:'Cloudy', tl:[
                {tm:'23:00',ti:'TPE â†’ DXB',d:'Emirates EK367 | æ¡ƒåœ’ T2 å‡ºç™¼ (è½‰æ©Ÿ 2h 55m)',loc:'Taoyuan Airport Terminal 2',l:[{t:'èˆªç­ç‹€æ…‹',u:'https://www.emirates.com/tw/chinese/manage-booking/flight-status/'}]}
            ]},
            { id:'d1', date:'2/1', wk:'é€±æ—¥', city:'Paris', t:'6Â°', c:'Rain', tl:[
                {tm:'12:25',ti:'æŠµé”å·´é» CDG',d:'Emirates EK073 | æŠµé” Terminal 2C',loc:'CDG Airport Terminal 2C', desc:'å‡ºé—œå¾Œä¾ç…§æŒ‡ç¤ºæ­ä¹˜ RER B ç·šé€²å¸‚å€ã€‚'},
                {tm:'13:30',ti:'æ©Ÿå ´å¾€å¸‚å€',d:'RER B -> Chatelet Les Halles (â‚¬11.8)',loc:'Chatelet Les Halles', desc:'äº¦å¯å« Uber/Boltï¼Œè²»ç”¨ç´„ â‚¬52-65ã€‚',l:[{t:'RATP å®˜ç¶²',u:'https://www.ratp.fr/en/titres-et-tarifs'}]},
                {tm:'15:00',ti:'Check-in',d:'15 Rue des Halles. è²· Navigo Easy å¡',loc:'15 Rue des Halles',desc:'ä½æ–¼å¸‚ä¸­å¿ƒçš„å…¬å¯“ï¼Œäº¤é€šä¾¿åˆ©ï¼Œæ¨“ä¸‹å°±æ˜¯å’–å•¡é¤¨ã€‚Navigo Easy ç©ºå¡ â‚¬2ï¼Œå¯å„²å€¼ Ticket t+ã€‚',tel:'+33 1 23 45 67 89'},
                {tm:'PM',ti:'Bastille æ¼«æ­¥',d:'Bastille å»£å ´ã€Village St. Paul',loc:'Place de la Bastille',desc:'å……æ»¿æ´»åŠ›çš„å€åŸŸï¼Œæœ‰è¨±å¤šå¤è‘£åº—å’Œæ­·å²éºè·¡ã€‚'}
            ]},
            { id:'d2', date:'2/2', wk:'é€±ä¸€', city:'Paris', t:'7Â°', c:'Cloudy', tl:[
                {tm:'09:00',ti:'ç¾…æµ®å®®',d:'Carrouselå…¥å£é€². çœ‹è’™å¨œéº—è',loc:'Carrousel du Louvre',imp:1,desc:'ä¸–ç•Œå››å¤§åšç‰©é¤¨ä¹‹é¦–ã€‚å¾ Carrousel è³¼ç‰©ä¸­å¿ƒå…¥å£é€²å…¥å¯é¿é–‹é‡‘å­—å¡”äººæ½®ã€‚é‡é»ï¼šDenon é¤¨ (è’™å¨œéº—è, å‹åˆ©å¥³ç¥)ã€‚',tel:'+33 1 40 20 53 17',l:[{t:'å®˜æ–¹è³¼ç¥¨',u:'https://www.ticketlouvre.fr/'}]},
                {tm:'Lunch',ti:'Le Fumoir',d:'è³ªæ„Ÿé¤é…’é¤¨',loc:'Le Fumoir Paris',eat:1,desc:'ä½æ–¼ç¾…æµ®å®®æ­£å°é¢ï¼Œæ°›åœå„ªé›…å¾©å¤ï¼Œå……æ»¿æ›¸å·æ°£æ¯çš„å·´é»äººæ°£é¤å»³ã€‚',menu:'é´¨èƒ¸ (Magret de canard), éŸƒé¼ç‰›è‚‰ (Tartare), é›å°¾é…’',tel:'+33 1 42 92 00 24',l:[{t:'å®˜ç¶²èœå–®',u:'http://lefumoir.com/'}]},
                {tm:'PM',ti:'æ­ŒåŠ‡é™¢',d:'OpÃ©ra Garnier',loc:'Palais Garnier',desc:'åŠ å°¼è‘‰æ­ŒåŠ‡é™¢ï¼Œå¯Œéº—å ‚çš‡çš„å·´æ´›å…‹å»ºç¯‰ï¼Œã€Šæ­ŒåŠ‡é­…å½±ã€‹çš„æ•…äº‹èƒŒæ™¯ã€‚',tel:'+33 1 71 25 24 23',l:[{t:'åƒè§€è³¼ç¥¨',u:'https://www.operadeparis.fr/en/visits/palais-garnier'}]},
                {tm:'Dinner',ti:'Pedra Alta',d:'å¿…åƒæµ·é®®ç›¤! Riz GrillÃ©',loc:'Pedra Alta Boulogne',eat:1,desc:'ä»½é‡é©šäººçš„è‘¡è„ç‰™æµ·é®®é¤å»³ï¼Œæ˜¯å·´é»CPå€¼æœ€é«˜çš„æµ·é®®é¦–é¸ã€‚(ä½æ–¼ Boulogne åˆ†åº—)',menu:'Riz GrillÃ© (æµ·é®®ç‡‰é£¯), Plateau Royal (çš‡å®¶æµ·é®®ç›¤)',tel:'+33 1 46 05 15 65',l:[{t:'Tripadvisor',u:'https://www.tripadvisor.com.tw/Restaurant_Review-g1079383-d1326442-Reviews-Pedra_Alta-Boulogne_Billancourt_Hauts_de_Seine_Ile_de_France.html'}]}
            ]},
            { id:'d3', date:'2/3', wk:'é€±äºŒ', city:'Paris', t:'5Â°', c:'Sunny', tl:[
                {tm:'08:00',ti:'å¾€å‡¡çˆ¾è³½',d:'RER C -> Versailles ChÃ¢teau Rive Gauche',loc:'Gare de Versailles ChÃ¢teau Rive Gauche',desc:'æ­ä¹˜ RER C (VICK ç­æ¬¡) é›™å±¤ç«è»Šå‰å¾€ï¼Œè»Šç¨‹ç´„40åˆ†é˜ã€‚',l:[{t:'äº¤é€šè³‡è¨Š',u:'https://en.chateauversailles.fr/plan-your-visit/getting-here'}]},
                {tm:'09:00',ti:'å‡¡çˆ¾è³½å®®',d:'éœ€é ç´„ Passport ç¥¨. èŠ±åœ’ç§Ÿçƒè»Š',loc:'Palace of Versailles',imp:1,desc:'è·¯æ˜“åå››çš„å¥¢è¯å®®æ®¿ï¼ŒPassport ç¥¨åŒ…å«å®®æ®¿èˆ‡èŠ±åœ’(â‚¬25-30)ã€‚å»ºè­°ç§Ÿé«˜çˆ¾å¤«çƒè»ŠéŠè¦½å»£å¤§èŠ±åœ’ã€‚',tel:'+33 1 30 83 78 00',l:[{t:'å®˜æ–¹è³¼ç¥¨',u:'https://ticket.chateauversailles.fr/'}]},
                {tm:'PM',ti:'éµå¡” & éŠèˆ¹',d:'Bateaux-Mouches (Pont de l\'Alma)',loc:'Bateaux-Mouches',desc:'æ­ä¹˜å¡ç´æ²³éŠèˆ¹ï¼Œå¾æ°´ä¸Šæ¬£è³å·´é»éµå¡”èˆ‡å…©å²¸é¢¨å…‰ã€‚ç¢¼é ­ä½æ–¼ Pont de l\'Almaã€‚',tel:'+33 1 42 25 96 10',l:[{t:'èˆ¹ç¥¨é ç´„',u:'https://www.bateaux-mouches.fr/en'}]}
            ]},
            { id:'d4', date:'2/4', wk:'é€±ä¸‰', city:'Paris', t:'6Â°', c:'Cloudy', tl:[
                {tm:'AM',ti:'è’™é¦¬ç‰¹',d:'æ„›ä¹‹ç‰† -> è–å¿ƒå ‚ -> å°ä¸˜å»£å ´',loc:'SacrÃ©-CÅ“ur',desc:'å……æ»¿è—è¡“æ°£æ¯çš„å±±ä¸˜ã€‚è·¯ç·šï¼šAbbessesç«™ (æ„›ä¹‹ç‰†) -> çºœè»Šä¸Šå±± -> è–å¿ƒå ‚ -> å°ä¸˜å»£å ´ (ç•«å®¶æ‘) -> é”åˆ©é”å»£å ´ -> ç´…ç£¨åŠã€‚',tel:'+33 1 53 41 89 00',l:[{t:'è–å¿ƒå ‚å®˜ç¶²',u:'https://www.sacre-coeur-montmartre.com/'}]},
                {tm:'Snack',ti:'Breizh CafÃ©',d:'æ³•å¼å¯éº—é¤…',loc:'Breizh CafÃ©',eat:1,desc:'ä½¿ç”¨å¸ƒåˆ—å¡”å°¼è•éº¥ç²‰è£½ä½œçš„æ­£å®—æ³•å¼è–„é¤…(Galette)ã€‚',menu:'Classic Jambon Fromage (ç«è…¿èµ·å¸è›‹), è˜‹æœé…’ (Cidre)',tel:'+33 1 42 72 13 77',l:[{t:'å®˜ç¶²',u:'https://www.breizhcafe.com/'}]},
                {tm:'PM',ti:'æ‹‰ä½›çˆºç™¾è²¨',d:'Gourmeté¤¨è²·éµè‚é†¬ã€é¦¬å¡é¾',loc:'Galeries Lafayette Haussmann',buy:1,desc:'å·´é»æœ€è‘—åçš„ç™¾è²¨å…¬å¸ï¼Œåœ“é ‚å»ºç¯‰æ¥µç¾ã€‚å¿…å»å°é¢çš„ã€ŒGourmet ç¾é£Ÿé¤¨ã€B1 è²·ä¼´æ‰‹ç¦® (Pierre HermÃ©, éµè‚é†¬)ã€‚',tel:'+33 1 42 82 34 56',l:[{t:'ç™¾è²¨å®˜ç¶²',u:'https://haussmann.galerieslafayette.com/en/'}]},
                {tm:'Dinner',ti:'L\'Escargot',d:'ç™¾å¹´è¸ç‰›é¤å»³',loc:'L\'Escargot Montorgueil',desc:'å‰µç«‹æ–¼1832å¹´çš„é‡‘è¸ç‰›é¤å»³ï¼Œæ˜¯é«”é©—æ³•å¼è¸ç‰›æ–™ç†çš„ç¶“å…¸è€åº—ã€‚',menu:'Escargots de Bourgogne (å‹ƒè‰®ç¬¬è¸ç‰›), é´¨è…¿',tel:'+33 1 42 36 83 51',l:[{t:'é¤å»³å®˜ç¶²',u:'https://escargotmontorgueil.com/'}]}
            ]},
            { id:'d5', date:'2/5', wk:'é€±å››', city:'Malta', t:'15Â°', c:'Sunny', tl:[
                {tm:'10:00',ti:'CDG â†’ MLA',d:'EasyJet | 12:55 æŠµé”',loc:'Malta International Airport', desc:'å¾ CDG Terminal 2B å‡ºç™¼ã€‚æŠµé”é¦¬çˆ¾ä»–å¾Œå»ºè­°ä½¿ç”¨ Bolt App å«è»Šå‰å¾€ Sliema (ç´„ â‚¬15-20)ã€‚',l:[{t:'EasyJet',u:'https://www.easyjet.com/'}]},
                {tm:'14:00',ti:'Sliema Check-in',d:'47 TignÃ© Seafront',loc:'47 TignÃ© Seafront',desc:'ä½æ–¼æµ·æ¿±å¤§é“çš„å…¬å¯“ï¼Œæ“æœ‰çµ•ä½³æµ·æ™¯ï¼Œå°é¢å°±æ˜¯ç“¦èŠå¡”ã€‚'},
                {tm:'PM',ti:'ç“¦èŠå¡”æ¼«æ­¥',d:'Triton Fountain, City Gate',loc:'Valletta City Gate',desc:'æ­æ´²æœ€å°çš„é¦–éƒ½ï¼Œå…¨åŸä¸–ç•Œæ–‡åŒ–éºç”¢ã€‚ç¶“éç‰¹é‡ŒåŒå™´æ³‰èˆ‡åŸé–€é€²å…¥ã€‚'},
                {tm:'15:30',ti:'Upper Barrakka',d:'ä¸Šå·´æ‹‰å¡èŠ±åœ’',loc:'Upper Barrakka Gardens',desc:'ç“¦èŠå¡”æœ€ä½³è§€æ™¯é»ï¼Œå¯ä¿¯ç°å¤§æ¸¯ (Grand Harbour) èˆ‡å°é¢çš„ä¸‰å§å¦¹åŸã€‚æœ‰é›»æ¢¯å¯ç›´é”æ¸¯å£ã€‚'},
                {tm:'16:00',ti:'è–ç´„ç¿°å¤§æ•™å ‚',d:'æ¥µè‡´è¯éº—å·´æ´›å…‹',loc:'St John\'s Co-Cathedral',imp:1,desc:'å¤–è§€æ¨¸ç´ ï¼Œå…§éƒ¨å»é‡‘ç¢§è¼ç…Œã€‚å¿…çœ‹å¡æ‹‰ç“¦å–¬åç•«ã€Šè¢«æ–¬é¦–çš„è–æ–½æ´—è€…ç´„ç¿°ã€‹ã€‚é–€ç¥¨ â‚¬15ï¼Œ16:15 æœ€å¾Œå…¥å ´ã€‚',tel:'+356 2122 0536',l:[{t:'åƒè§€è³‡è¨Š',u:'https://www.stjohnscocathedral.com/'}]}
            ]},
            { id:'d6', date:'2/6', wk:'é€±äº”', city:'Malta', t:'16Â°', c:'Sunny', tl:[
                {tm:'AM',ti:'Mdina å¤åŸ',d:'æ¬ŠåŠ›éŠæˆ²æ‹æ”åœ°',loc:'Mdina Gate',imp:1,desc:'è¢«ç¨±ç‚ºã€Œå¯‚éœä¹‹åŸã€(Silent City)ï¼Œä¸­ä¸–ç´€é¢¨è²Œä¿å­˜å®Œæ•´ï¼Œæ˜¯ã€Šæ¬ŠåŠ›éŠæˆ²ã€‹ç¬¬ä¸€å­£å›è‡¨åŸå–æ™¯åœ°ã€‚',l:[{t:'Mdina ä»‹ç´¹',u:'https://www.visitmalta.com/en/a/mdina/'}]},
                {tm:'Break',ti:'Fontanella',d:'åŸç‰†è›‹ç³•åº—ï¼Œé¢¨æ™¯çµ•ä½³',loc:'Fontanella Tea Garden',eat:1,desc:'ä½æ–¼ Mdina åŸç‰†ä¸Šçš„èŒ¶å®¤ï¼Œæ“æœ‰çœºæœ›é¦¬çˆ¾ä»–å…¨å³¶çš„ç„¡æ•µè¦–é‡ã€‚',menu:'ç¶“å…¸å·§å…‹åŠ›è›‹ç³• (Classic Chocolate Cake), è‰è“å¡”',tel:'+356 2145 4264',l:[{t:'Menu',u:'https://fontanellateagarden.com/'}]},
                {tm:'PM',ti:'St. Julian\'s',d:'Balluta Bay æ•£æ­¥',loc:'Balluta Bay',desc:'ç†±é¬§çš„å¤œç”Ÿæ´»å€ï¼Œæ“æœ‰ç¾éº—çš„æ–°å“¥å¾·å¼æ•™å ‚èˆ‡æµ·ç£æ­¥é“ã€‚æ™šé¤æ¨è–¦ Yana\'s æˆ– Tapeaã€‚'}
            ]},
            { id:'d7', date:'2/7', wk:'é€±å…­', city:'Malta', t:'15Â°', c:'Cloudy', tl:[
                {tm:'08:45',ti:'å¾€ Gozo å³¶',d:'Cirkewwa æ­æ¸¡è¼ª',loc:'Cirkewwa Ferry Terminal',desc:'å‰å¾€é¦¬çˆ¾ä»–ç¬¬äºŒå¤§å³¶ã€‚æ­ä¹˜ Gozo Channel Lineï¼Œç´„ 25 åˆ†é˜ã€‚',tel:'+356 2210 9000',l:[{t:'æ¸¡è¼ªæ™‚åˆ»è¡¨',u:'https://www.gozochannel.com/ferry/schedule/'}]},
                {tm:'AM',ti:'Victoria Citadel',d:'å³¶ä¸­å¿ƒåŸå ¡',loc:'The Citadel Victoria',desc:'Gozo å³¶çš„åˆ¶é«˜é»è¦å¡ï¼Œå¯ 360 åº¦ä¿¯ç°å…¨å³¶æ™¯è‰²ã€‚'},
                {tm:'Noon',ti:'Dwejra & Inland Sea',d:'å…§æµ·æ­å°èˆ¹',loc:'Dwejra Bay',desc:'é›–ç„¶è—çª—å·²å€’å¡Œï¼Œä½†åœ¨æ­¤è™•æ­ä¹˜å°èˆ¹ (â‚¬4) ç©¿éå²©æ´é€²å…¥é–‹æ”¾æ°´åŸŸ (Inland Sea) çš„é«”é©—éå¸¸ç¨ç‰¹ã€‚'}
            ]},
            { id:'d8', date:'2/8', wk:'é€±æ—¥', city:'Malta', t:'16Â°', c:'Sunny', tl:[
                {tm:'AM',ti:'Marsaxlokk é­šå¸‚',d:'é€±æ—¥é™å®š! æ‹å½©è‰²æ¼èˆ¹',loc:'Marsaxlokk Market',imp:1,desc:'å‚³çµ±å°æ¼æ‘ï¼Œé€±æ—¥æœ‰å¤§å‹å¸‚é›†ï¼Œè²©è³£æµ·é®®ã€ç´€å¿µå“ã€‚æµ·é¢ä¸Šåœæ»¿å½©è‰²çš„ Luzzu æ¼èˆ¹ (èˆ¹é ­æœ‰è·é­¯æ–¯ä¹‹çœ¼)ã€‚'},
                {tm:'Noon',ti:'è—æ´',d:'æ­èˆ¹è³æµ·è•æ´',loc:'Blue Grotto Malta',desc:'ä»¥æµ·æ°´æ¹›è—èåçš„æµ·è•æ´ç¾¤ï¼Œå¤©æ°£å¥½æ™‚æµ·æ°´æœƒç™¼å‡ºè¢å…‰è—ã€‚èˆ¹ç¥¨ç´„ â‚¬8ã€‚',l:[{t:'è—æ´è³‡è¨Š',u:'https://www.visitmalta.com/en/a/blue-grotto/'}]},
                {tm:'PM',ti:'ä¸‰å§å¦¹åŸ',d:'æ­æ°´ä¸Šè¨ˆç¨‹è»Šå» Vittoriosa',loc:'The Three Cities',desc:'èˆ‡ç“¦èŠå¡”å°æœ›çš„ä¸‰åº§å¤åŸ (Vittoriosa, Senglea, Cospicua)ã€‚å¯å¾ç“¦èŠå¡”æ­æ°´ä¸Šè¨ˆç¨‹è»Š (â‚¬2.8) å‰å¾€ã€‚'}
            ]},
            { id:'d9', date:'2/9', wk:'é€±ä¸€', city:'Venice', t:'8Â°', c:'Rain', tl:[
                {tm:'17:20',ti:'MLA â†’ VCE',d:'Ryanair | 19:15 æŠµé”',loc:'Venice Marco Polo Airport',l:[{t:'Ryanair',u:'https://www.ryanair.com/'}]},
                {tm:'Trans',ti:'æ©Ÿå ´é€²åŸ',d:'è²· Rolling Venice Card',loc:'Venice Marco Polo Airport',desc:'åœ¨æ©Ÿå ´è³¼è²· Rolling Venice Card (â‚¬6, é™6-29æ­²)ï¼Œå¯äº« 72hr ACTV äº¤é€šå¡å„ªæƒ åƒ¹ (â‚¬27)ã€‚æ­å·´å£«é€² Piazzale Roma å†è½‰èˆ¹ã€‚',l:[{t:'Venezia Unica',u:'https://www.veneziaunica.it/en/e-commerce/services'}]},
                {tm:'Hotel',ti:'Check-in',d:'Carnival Palace (Cannaregioå€)',loc:'Carnival Palace Hotel',desc:'ä½æ–¼ Tre Archi ç¢¼é ­æ—ï¼Œç’°å¢ƒæ¸…å¹½çš„é«˜ç´šé£¯åº—ã€‚',tel:'+39 041 244 1611'}
            ]},
            { id:'d10', date:'2/10', wk:'é€±äºŒ', city:'Venice', t:'9Â°', c:'Cloudy', tl:[
                {tm:'AM',ti:'é‡Œäºæ‰˜æ©‹',d:'å¨å°¼æ–¯åœ°æ¨™',loc:'Ponte di Rialto',desc:'æ©«è·¨å¤§é‹æ²³æœ€å¤è€çš„æ©‹æ¨‘ï¼Œå‘¨é‚Šå•†åº—æ—ç«‹ï¼Œæ˜¯æ‹æ”å¤§é‹æ²³çš„æœ€ä½³è§’åº¦ã€‚'},
                {tm:'Sight',ti:'æ²‰èˆ¹æ›¸åº—',d:'è²¢å¤šæ‹‰è£æ›¸',loc:'Libreria Acqua Alta',desc:'è¢«è­½ç‚ºä¸–ç•Œæœ€ç¾æ›¸åº—ä¹‹ä¸€ï¼Œç”¨è²¢å¤šæ‹‰èˆ¹å’Œæµ´ç¼¸è£æ›¸ä»¥é˜²æ·¹æ°´ã€‚'},
                {tm:'PM',ti:'è–é¦¬å¯å»£å ´',d:'å¤§æ•™å ‚ã€ç¸½ç£å®®',loc:'Piazza San Marco',imp:1,desc:'æ‹¿ç ´å´™ç¨±ä¹‹ç‚ºã€Œæ­æ´²æœ€ç¾çš„å®¢å»³ã€ã€‚åƒè§€è–é¦¬å¯å¤§æ•™å ‚ (é‡‘ç¢§è¼ç…Œçš„é¦¬è³½å…‹) èˆ‡ç¸½ç£å®® (Doge\'s Palace)ã€‚',l:[{t:'å¤§æ•™å ‚é ç´„',u:'https://basilicasanmarco.skiperformance.com/en/store#/en/buy'},{t:'ç¸½ç£å®®è³¼ç¥¨',u:'https://palazzoducale.visitmuve.it/en/pianifica-la-tua-visita/tickets/'}]},
                {tm:'Break',ti:'èŠ±ç¥å’–å•¡',d:'ä¸–ç•Œæœ€å¤è€å’–å•¡é¤¨',loc:'CaffÃ¨ Florian',desc:'å‰µæ¥­æ–¼1720å¹´ï¼Œè£æ½¢è¯éº—ã€‚å®¤å…§ä¸‹åˆèŒ¶é«”é©—ç„¡åƒ¹ã€‚',tel:'+39 041 520 5641',l:[{t:'å®˜ç¶²',u:'https://www.caffeflorian.com/en/'}]},
                {tm:'Shop',ti:'Despar Teatro Italia',d:'æœ€ç¾è¶…å¸‚',loc:'Despar Teatro Italia',desc:'ç”±å¤è€åŠ‡é™¢æ”¹å»ºçš„è¶…å¸‚ï¼Œä¿ç•™äº†åŠ‡é™¢çš„å¤©èŠ±æ¿å£ç•«èˆ‡èˆå°ï¼Œéå¸¸ç‰¹åˆ¥ã€‚'}
            ]},
            { id:'d11', date:'2/11', wk:'é€±ä¸‰', city:'Venice', t:'8Â°', c:'Sunny', tl:[
                {tm:'09:00',ti:'Murano ç»ç’ƒå³¶',d:'æ­ 4.1/4.2 è™Ÿèˆ¹',loc:'Murano',desc:'ä»¥ç»ç’ƒå·¥è—èåçš„å°å³¶ï¼Œå¯åƒè§€ç»ç’ƒå·¥å» å¹è£½éç¨‹ã€‚',l:[{t:'æ°´ä¸Šå·´å£«åœ–',u:'https://actv.avmspa.it/en/content/water-bus-service-timetable-0'}]},
                {tm:'11:00',ti:'Burano å½©è‰²å³¶',d:'æ­ 12 è™Ÿèˆ¹',loc:'Burano',imp:1,desc:'ä»¥è•¾çµ²å·¥è—å’Œè‰²å½©ç¹½ç´›çš„æˆ¿å­èåï¼Œå½·å½¿ç½®èº«ç«¥è©±ä¸–ç•Œã€‚'},
                {tm:'Dinner',ti:'Trattoria Bar Pontini',d:'æµ·é®®ç¾©å¤§åˆ©éºµ',loc:'Trattoria Bar Pontini',eat:1,desc:'é‹æ²³é‚Šçš„é«˜äººæ°£é¤å»³ï¼Œæµ·é®®æ–°é®®ï¼Œå»ºè­°æå‰æ’éšŠã€‚',menu:'æµ·é®®ç¾©å¤§åˆ©éºµ (Spaghetti allo Scoglio), å¢¨é­šéºµ',tel:'+39 041 714123',l:[{t:'Tripadvisor',u:'https://www.tripadvisor.com/Restaurant_Review-g187870-d2326732-Reviews-Trattoria_Bar_Pontini-Venice_Veneto.html'}]}
            ]},
            { id:'d12', date:'2/12', wk:'é€±å››', city:'Florence', t:'11Â°', c:'Sunny', tl:[
                {tm:'11:05',ti:'Italo ç«è»Š',d:'å¾€ Florence (13:20æŠµé”)',loc:'Venezia Santa Lucia',desc:'æ­ä¹˜ Italo 8911 ç­æ¬¡ã€‚æŠµé”å¾Œå‰å¾€ Piazza della Stazione å…¬å¯“ check-inã€‚',l:[{t:'Italo å®˜ç¶²',u:'https://www.italotreno.it/en'}]},
                {tm:'Lunch',ti:'Trattoria ZÃ  ZÃ ',d:'å¿…åƒä¸éª¨ç‰›æ’',loc:'Trattoria ZÃ  ZÃ ',eat:1,desc:'ä½›ç¾…å€«æ–¯å¿…åƒçš„ä¸éª¨ç‰›æ’è€åº—ï¼Œè£æ½¢å¾©å¤ï¼Œä»½é‡åè¶³ã€‚',menu:'ä¸éª¨ç‰›æ’ (Bistecca alla Fiorentina) - å»ºè­°é»1kg',tel:'+39 055 215411',l:[{t:'å®˜ç¶²è¨‚ä½',u:'https://www.trattoriazaza.it/'}]},
                {tm:'PM',ti:'Fiesole å±±åŸ',d:'æ­7è™Ÿå…¬è»Šçœ‹å…¨æ™¯',loc:'Fiesole',desc:'æ­ä¹˜ Bus 7 (ç´„30-40åˆ†) å‰å¾€è¿‘éƒŠå±±åŸï¼Œå¯ä¿¯ç°æ•´å€‹æ‰˜æ–¯å¡å°¼å¹³åŸèˆ‡ä½›ç¾…å€«æ–¯å…¨æ™¯ï¼Œé©åˆçœ‹å¤•é™½ã€‚'}
            ]},
            { id:'d13', date:'2/13', wk:'é€±äº”', city:'Florence', t:'12Â°', c:'Cloudy', tl:[
                {tm:'Lunch',ti:'Da Nerbone',d:'å¿…åƒç‰›è‚šåŒ… (ä¸­å¤®å¸‚å ´)',loc:'Mercato Centrale Firenze',eat:1,desc:'ä½æ–¼ä¸­å¤®å¸‚å ´å…§çš„ç™¾å¹´è€æ”¤ï¼Œç‰›è‚šç‡‰å¾—è»Ÿçˆ›å…¥å‘³ã€‚14:00 æ”¶æ”¤ã€‚',menu:'ç‰›è‚šåŒ… (Lampredotto), ç‰›è‚‰åŒ… (Bollito)',l:[{t:'ä¸­å¤®å¸‚å ´',u:'https://www.mercatocentrale.it/florence/'}]},
                {tm:'PM',ti:'ç™¾èŠ±å¤§æ•™å ‚',d:'ç™»é ‚éœ€é ç´„',loc:'Santa Maria del Fiore',imp:1,desc:'æ–‡è—å¾©èˆˆçš„è±¡å¾µï¼Œå·¨å¤§çš„ç´…è‰²åœ“é ‚ã€‚ç™»é ‚éœ€è³¼è²· Brunelleschi Pass ä¸¦é ç´„æ™‚æ®µã€‚',tel:'+39 055 230 2885',l:[{t:'å®˜æ–¹è³¼ç¥¨',u:'https://duomo.firenze.it/en/home'}]},
                {tm:'Sight',ti:'è€æ©‹',d:'é‡‘é£¾åº—å¤æ©‹',loc:'Ponte Vecchio',desc:'é˜¿è«¾æ²³ä¸Šæœ€å¤è€çš„æ©‹ï¼Œæ©‹ä¸Šå…©å´éƒ½æ˜¯é‡‘é£¾ç å¯¶åº—ã€‚'}
            ]},
            { id:'d14', date:'2/14', wk:'é€±å…­', city:'Florence', t:'12Â°', c:'Sunny', tl:[
                {tm:'09:53',ti:'å¾€æ¯”è–©',d:'ç«è»Šåˆ° Pisa S. Rossore',loc:'Pisa San Rossore',desc:'æ­ä¹˜å€é–“è»Šå‰å¾€ Pisa S. Rossore ç«™ï¼Œä¸‹è»Šèµ°è·¯ 5 åˆ†é˜å³é”æ–œå¡” (æ¯”ä¸­å¤®è»Šç«™è¿‘)ã€‚',l:[{t:'ç¾©éµ Trenitalia',u:'https://www.trenitalia.com/en.html'}]},
                {tm:'AM',ti:'æ¯”è–©æ–œå¡”',d:'å¥‡è¹Ÿå»£å ´æ‹ç…§',loc:'Leaning Tower of Pisa',imp:1,desc:'ä¸–ç•Œä¸ƒå¤§å¥‡æ™¯ä¹‹ä¸€ã€‚ç™»å¡”éœ€å¯„æ”¾åŒ…åŒ…ã€‚',tel:'+39 050 835011',l:[{t:'ç™»å¡”è³¼ç¥¨',u:'https://www.opapisa.it/en/tickets/buy/'}]},
                {tm:'Dinner',ti:'Osteria Pastella',d:'è»Šè¼ªèµ·å¸æ¾éœ²éºµ',loc:'Osteria Pastella',eat:1,desc:'ä»¥å·¨å‹å¸•ç‘ªæ£®èµ·å¸è¼ªç¾å ´æ‹Œç‚’çš„æ¾éœ²ç¾©å¤§åˆ©éºµèåï¼Œè¦–è¦ºå‘³è¦ºé›™é‡äº«å—ã€‚',menu:'æ¾éœ²èµ·å¸ç¾©å¤§åˆ©éºµ (Tagliatelle al Tartufo)',tel:'+39 055 264 5917',l:[{t:'å®˜ç¶²',u:'https://www.osteriapastella.it/'}]}
            ]},
            { id:'d15', date:'2/15', wk:'é€±æ—¥', city:'Rome', t:'13Â°', c:'Sunny', tl:[
                {tm:'09:28',ti:'Italo ç«è»Š',d:'å¾€ Roma Termini (11:05æŠµé”)',loc:'Roma Termini',desc:'æ­ä¹˜ Italo 8903 ç­æ¬¡ã€‚æŠµé”ç¾…é¦¬ Termini è»Šç«™ã€‚ä½å®¿ä½æ–¼è¥¿ç­ç‰™å»£å ´é™„è¿‘ã€‚',l:[{t:'Italo å®˜ç¶²',u:'https://www.italotreno.it/en'}]},
                {tm:'Hotel',ti:'Check-in',d:'è¿‘è¥¿ç­ç‰™å»£å ´',loc:'Via dei Due Macelli 31',desc:'äº¤é€šä¾¿åˆ©ï¼Œé™„è¿‘æ˜¯è³¼ç‰©ç²¾è¯å€ã€‚',tel:'+39 06 679 4223'},
                {tm:'Snack',ti:'Pompi TiramisÃ¹',d:'å¿…åƒææ‹‰ç±³è˜‡',loc:'Pompi TiramisÃ¹',eat:1,desc:'ç¾…é¦¬è‘—åçš„ææ‹‰ç±³è˜‡å°ˆè³£åº—ï¼Œå£å‘³é¸æ“‡å¤šï¼Œæ¨è–¦ç¶“å…¸åŸå‘³æˆ–è‰è“ã€‚',menu:'ç¶“å…¸ææ‹‰ç±³è˜‡, è‰è“ææ‹‰ç±³è˜‡',tel:'+39 06 6880 1779',l:[{t:'å®˜ç¶²',u:'https://barpompi.it/'}]}
            ]},
            { id:'d16', date:'2/16', wk:'é€±ä¸€', city:'Rome', t:'14Â°', c:'Sunny', tl:[
                {tm:'13:20',ti:'ç¾…é¦¬ç«¶æŠ€å ´',d:'é ç´„ Arena Floor',loc:'Colosseum',imp:1,desc:'å¤ç¾…é¦¬å¸åœ‹çš„è±¡å¾µã€‚å·²é ç´„ 13:20 Arena Floor (ç«¶æŠ€å ´å¹³è‡º) é–€ç¥¨ï¼Œå¯é€²å…¥ä¸­å¿ƒæ„Ÿå—è§’é¬¥å£«è¦–è§’ã€‚',tel:'+39 06 3996 7700',l:[{t:'å®˜æ–¹è³¼ç¥¨',u:'https://www.coopculture.it/en/products/ticket-colosseum-roman-forum-palatine_24h/'}]},
                {tm:'PM',ti:'è¨±é¡˜æ± ',d:'Fontana di Trevi',loc:'Trevi Fountain',imp:1,desc:'ç¾…é¦¬æœ€å¤§çš„å·´æ´›å…‹é¢¨æ ¼å™´æ³‰ï¼Œå‚³èªªèƒŒå°å™´æ³‰æŠ•æ“²ç¡¬å¹£å¯é‡è¿”ç¾…é¦¬ã€‚'},
                {tm:'Dinner',ti:'CiPASSO',d:'é«˜äººæ°£é¤å»³',loc:'CiPASSO Vineria Bistrot',desc:'æ°£æ°›æ¥µä½³çš„ç¾ä»£ç¾©å¼é¤é…’é¤¨ï¼Œæ–™ç†ç²¾ç·»ï¼Œæœå‹™è¦ªåˆ‡ã€‚',menu:'ç« é­šè…³ (Octopus), ç¾…é¦¬åŸ¹æ ¹è›‹éºµ (Carbonara)',tel:'+39 06 6889 2620',l:[{t:'å®˜ç¶²è¨‚ä½',u:'https://www.cipasso.com/'}]}
            ]},
            { id:'d17', date:'2/17', wk:'é€±äºŒ', city:'Rome', t:'14Â°', c:'Cloudy', tl:[
                {tm:'14:00',ti:'æ¢µè’‚å²¡åšç‰©é¤¨',d:'è¥¿æ–¯æ±€ç¦®æ‹œå ‚',loc:'Vatican Museums',imp:1,desc:'ä¸–ç•Œæœ€å‰å¤§çš„åšç‰©é¤¨ä¹‹ä¸€ï¼Œå·²é ç´„ 14:00ã€‚å¿…çœ‹ç±³é–‹æœ—åŸºç¾…çš„ã€Šå‰µä¸–ç´€ã€‹èˆ‡ã€Šæœ€å¾Œçš„å¯©åˆ¤ã€‹ã€‚',tel:'+39 06 6988 4676',l:[{t:'å®˜æ–¹è³¼ç¥¨',u:'https://tickets.museivaticani.va/home'}]},
                {tm:'16:30',ti:'è–å½¼å¾—å¤§æ•™å ‚',d:'ä¸–ç•Œæœ€å¤§æ•™å ‚',loc:'St. Peter\'s Basilica',desc:'å¤©ä¸»æ•™çš„ä¸­å¿ƒï¼Œå…§éƒ¨å®å‰èŠåš´ï¼Œæœ‰ç±³é–‹æœ—åŸºç¾…çš„ã€Šè–æ®¤ã€‹ã€‚'},
                {tm:'18:00',ti:'è–å¤©ä½¿å ¡',d:'Castel Sant\'Angelo',loc:'Castel Sant\'Angelo',desc:'åŸç‚ºå“ˆå¾·è‰¯çš‡å¸é™µå¯¢ï¼Œå¾Œæ”¹ç‚ºåŸå ¡ã€‚å¾è–å¤©ä½¿æ©‹æ‹æ”åŸå ¡æ˜¯ç¶“å…¸è§’åº¦ã€‚'},
                {tm:'Coffee',ti:'é‡‘æ¯å’–å•¡',d:'å¿…å– Coffee Granita',loc:'Tazza d\'Oro',eat:1,desc:'è¬ç¥æ®¿æ—çš„è€å­—è™Ÿå’–å•¡åº—ï¼Œè¢«è­½ç‚ºå…¨ç¾…é¦¬æœ€å¥½å–çš„å’–å•¡ã€‚',menu:'å’–å•¡å†°æ²™ (Granita di CaffÃ¨)',tel:'+39 06 678 9792',l:[{t:'å®˜ç¶²',u:'https://www.tazzadorocoffeeshop.com/'}]}
            ]},
            { id:'d18', date:'2/18', wk:'é€±ä¸‰', city:'Rome', t:'13Â°', c:'Rain', tl:[
                {tm:'Lunch',ti:'Piccolo Buco',d:'è¶…äººæ°£ Pizza',loc:'Piccolo Buco',eat:1,desc:'è¨±é¡˜æ± æ—æ’éšŠååº—ï¼Œä»¥é•·æ™‚é–“ç™¼é…µçš„é¤…çš®èåã€‚',menu:'ç‘ªæ ¼éº—ç‰¹æŠ«è–©, é»ƒè‰²ç•ªèŒ„æŠ«è–©',tel:'+39 06 6938 0163',l:[{t:'å®˜ç¶²',u:'https://www.pizzeriapiccolobuco.it/'}]},
                {tm:'17:00',ti:'æ©Ÿå ´å¿«ç·š',d:'Termini -> FCO æ©Ÿå ´',loc:'Fiumicino Airport',desc:'æ­ä¹˜ Leonardo Express ç›´é”æ©Ÿå ´ (ç´„ â‚¬14, 32åˆ†é˜)ã€‚',l:[{t:'Leonardo Express',u:'https://www.trenitalia.com/en/services/leonardo-express.html'}]},
                {tm:'20:50',ti:'FCO â†’ DXB',d:'Emirates è¿”ç¨‹',loc:'Fiumicino Airport Terminal 3',l:[{t:'Emirates',u:'https://www.emirates.com/'}]}
            ]},
            { id:'d19', date:'2/19', wk:'é€±å››', city:'Taipei', t:'21Â°', c:'Cloudy', tl:[
                {tm:'20:40',ti:'æŠµé”å°åŒ—',d:'æ—…ç¨‹çµæŸï¼',loc:'Taoyuan Airport'}
            ]}
        ];

        const FLIGHTS = [
            {t:'1/31 Â· TPE â†’ DXB',v:'23:00',n:'Emirates EK367', u:'https://www.emirates.com/tw/chinese/manage-booking/flight-status/'}, 
            {t:'2/1 Â· DXB â†’ CDG',v:'12:25',n:'Emirates EK073 (Arr T2C)', u:'https://www.emirates.com/tw/chinese/manage-booking/flight-status/'},
            {t:'2/5 Â· CDG â†’ MLA',v:'10:00',n:'EasyJet (Dep T2B)', u:'https://www.easyjet.com/'}, 
            {t:'2/9 Â· MLA â†’ VCE',v:'17:20',n:'Ryanair', u:'https://www.ryanair.com/'},
            {t:'2/18 Â· FCO â†’ DXB',v:'20:50',n:'Emirates (Dep T3)', u:'https://www.emirates.com/tw/chinese/manage-booking/flight-status/'}, 
            {t:'2/19 Â· DXB â†’ TPE',v:'20:40',n:'Arr Taipei'}
        ];

        const HOTELS = [
            {t:'Paris',v:'Apartment',d:'15 Rue des Halles',n:'Booking',l:'15 Rue des Halles', dt:'2/1 - 2/5 (4æ™š)', u:'https://www.booking.com'},
            {t:'Malta',v:'Sliema Apt',d:'47 TignÃ© Seafront',n:'Booking',l:'47 TignÃ© Seafront', dt:'2/5 - 2/9 (4æ™š)', u:'https://www.booking.com'},
            {t:'Venice',v:'Carnival Palace',d:'Cannaregio, 929',n:'Agoda',l:'Carnival Palace Hotel', dt:'2/9 - 2/12 (3æ™š)', u:'https://www.agoda.com'},
            {t:'Florence',v:'Station Apt',d:'Piazza della Stazione',n:'Booking',l:'Piazza della Stazione 1 Firenze', dt:'2/12 - 2/15 (3æ™š)', u:'https://www.booking.com'},
            {t:'Rome',v:'Spagna Apt',d:'Via dei Due Macelli',n:'Agoda',l:'Via dei Due Macelli 31 Roma', dt:'2/15 - 2/18 (3æ™š)', u:'https://www.agoda.com'}
        ];

        const AI_STORAGE_KEY = 'trip2026_ai_data';
        const API_KEY_STORAGE_KEY = 'trip2026_gemini_key';

        // --- App Component ---
        function App() {
            const [currentTab, setCurrentTab] = useState('trip');
            const [expandedDayId, setExpandedDayId] = useState('d1');
            const [showInstallModal, setShowInstallModal] = useState(false);
            const [showApiModal, setShowApiModal] = useState(false);
            const [toast, setToast] = useState({ show: false, message: '' });
            const [weatherModal, setWeatherModal] = useState({ visible: false, city: null, loading: false, data: null, error: false });
            const [aiData, setAiData] = useState(null);
            const [apiKey, setApiKey] = useState('');
            const [isFetchingAi, setIsFetchingAi] = useState(false);

            useEffect(() => {
                try {
                    const storedAi = localStorage.getItem(AI_STORAGE_KEY);
                    if (storedAi) setAiData(JSON.parse(storedAi));
                    const storedKey = localStorage.getItem(API_KEY_STORAGE_KEY);
                    if (storedKey) setApiKey(storedKey);
                } catch (e) { console.log('Storage access failed'); }
            }, []);

            useEffect(() => { window.scrollTo(0, 0); }, [currentTab]);

            const showToastMessage = (msg) => {
                setToast({ show: true, message: msg });
                setTimeout(() => setToast({ show: false, message: '' }), 3000);
            };

            const toggleInstallGuide = () => setShowInstallModal(!showInstallModal);
            const toggleApiModal = () => setShowApiModal(!showApiModal);
            
            const saveApiKeyFunc = (keyInput) => {
                const key = keyInput.trim();
                if (key) {
                    try { localStorage.setItem(API_KEY_STORAGE_KEY, key); } catch(e) {
                        showToastMessage("ç„¡æ³•å„²å­˜ Key");
                        return;
                    }
                    setApiKey(key);
                    toggleApiModal();
                    showToastMessage("Key å·²å„²å­˜ï¼");
                    if(currentTab === 'guide') fetchAiGuide(getCurrentCity(), true, key);
                } else {
                    showToastMessage("è«‹è¼¸å…¥æœ‰æ•ˆçš„ API Key");
                }
            };

            const toggleDay = (id) => setExpandedDayId(expandedDayId === id ? null : id);

            const openWeather = (city, e) => {
                if(e) e.stopPropagation();
                setWeatherModal({ visible: true, city, loading: true, data: null, error: false });
                const coords = CITY_COORDS[city];
                if(!coords) { setWeatherModal({ visible: true, city, loading: false, data: null, error: true }); return; }
                fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lng}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,is_day&daily=temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=auto`)
                    .then(res => res.json()).then(data => setWeatherModal(prev => ({ ...prev, loading: false, data: data })))
                    .catch(() => setWeatherModal(prev => ({ ...prev, loading: false, error: true })));
            };

            const closeWeather = () => setWeatherModal(prev => ({ ...prev, visible: false }));

            const getCurrentCity = () => {
                const today = new Date();
                const dateStr = `${today.getMonth() + 1}/${today.getDate()}`;
                const match = TRIP.find(d => d.date === dateStr);
                return match ? match.city : 'Europe';
            };

            const fetchAiGuide = async (city, force = false, keyOverride = null) => {
                if (isFetchingAi && !force) return;
                setIsFetchingAi(true);
                const keyToUse = keyOverride || apiKey;
                if (!keyToUse) { setIsFetchingAi(false); return; }

                const today = new Date();
                const dateStr = `${today.getMonth() + 1}/${today.getDate()}`;
                const todayItinerary = TRIP.find(d => d.date === dateStr);
                let itineraryContext = "No specific itinerary data found.";
                if (todayItinerary && todayItinerary.tl) {
                    itineraryContext = todayItinerary.tl.map(item => `- ${item.ti}: ${item.d}`).join('\n');
                }

                const prompt = `You are a professional local tour guide in ${city}.
                Here is the traveler's itinerary for today (${dateStr}):
                ${itineraryContext}

                Please provide a detailed, high-value daily guide in Traditional Chinese (ç¹é«”ä¸­æ–‡).

                CRITICAL: You MUST separate your response into FOUR distinct parts using the delimiter "|||".
                Format:
                [Part 1: Daily Briefing] ||| [Part 2: Transport Guide] ||| [Part 3: Must Eat List] ||| [Part 4: Must Buy List]

                Content Requirements:
                Part 1: Daily Briefing
                - Weather outfit advice for today.
                - 1-2 Specific hacks for today's spots.

                Part 2: Transport Guide
                - SPECIFICALLY how to get between the places in today's itinerary.

                Part 3: Must Eat List (Food & Restaurants)
                - List EXACTLY 5 food items or restaurants LOCATED NEAR today's itinerary spots (${itineraryContext}).
                - For each item:
                  1. Name (and dish recommendation)
                  2. Brief description
                  3. **Location & How to get there from the nearest itinerary spot.** (e.g., "From Louvre, walk 5 mins north...")

                Part 4: Must Buy List (Shopping)
                - List EXACTLY 5 unique items or shops LOCATED NEAR today's itinerary spots (${itineraryContext}).
                - For each item:
                  1. Shop Name / Item Name
                  2. Brief description
                  3. **Location & How to get there from the nearest itinerary spot.**

                Keep descriptions concise but useful. Use emojis. Do not output Markdown headers like "# Part 1".`;

                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 20000); // Increased timeout for longer response
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${keyToUse}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    if (!response.ok) throw new Error(response.statusText);
                    const data = await response.json();
                    if (data.candidates && data.candidates.length > 0) {
                        const content = data.candidates[0].content.parts[0].text;
                        const saveData = { date: new Date().toLocaleDateString(), city: city, content: content };
                        setAiData(saveData);
                        try { localStorage.setItem(AI_STORAGE_KEY, JSON.stringify(saveData)); } catch(e){}
                    } else { throw new Error('No content'); }
                } catch (error) {
                    showToastMessage("é€£ç·šä¸ç©©ï¼Œå·²è¼‰å…¥é›¢ç·šæ”»ç•¥");
                    const mockContent = `**ğŸŒ¤ï¸ å¤©æ°£èˆ‡ç©¿æ­**\n${city} æ—©æ™šæº«å·®å¤§ï¼Œå»ºè­°æ´‹è”¥å¼ç©¿æ­ã€‚\n\n**ğŸ’¡ è¡Œç¨‹å°æ’‡æ­¥**\né¿é–‹å°–å³°æ™‚æ®µç”¨é¤ã€‚\n|||**ğŸš— äº¤é€šå»ºè­°**\nä½¿ç”¨ Google Maps æˆ–ç•¶åœ°äº¤é€š App æŸ¥è©¢æœ€ä½³è·¯ç·šã€‚\n|||**ğŸ½ï¸ å¿…åƒç¾é£Ÿ (è¡Œç¨‹é™„è¿‘)**\n1. ç•¶åœ°ç‰¹è‰²å°åƒ - å°±åœ¨æ™¯é»æ—ã€‚\n2. å¿…åƒç”œé» - æ­¥è¡Œ5åˆ†é˜ã€‚\n3. äººæ°£å’–å•¡å»³ - è½‰è§’å³é”ã€‚\n4. å‚³çµ±å¸‚å ´ç¾é£Ÿ - é«”é©—ç•¶åœ°ç”Ÿæ´»ã€‚\n5. éš±è—ç‰ˆæ™šé¤ - éœ€æå‰é ç´„ã€‚\n|||**ğŸ›ï¸ å¿…è²·å¥½ç‰© (è¡Œç¨‹é™„è¿‘)**\n1. ç‰¹è‰²ç´€å¿µå“ - æ™¯é»å•†åº—ã€‚\n2. æ‰‹å·¥è—å“ - é™„è¿‘å··å¼„ã€‚\n3. ç•¶åœ°é›¶é£Ÿ - è¶…å¸‚å¯è²·ã€‚\n4. è¨­è¨ˆå°ç‰© - æ–‡å‰µåº—ã€‚\n5. é™å®šä¼´æ‰‹ç¦® - æ©Ÿå ´ä¹Ÿæœ‰ã€‚`;
                    setAiData({ date: new Date().toLocaleDateString(), city: city, content: mockContent });
                } finally { setIsFetchingAi(false); }
            };

            return (
                <div className="bg-[#F2F2F7] dark:bg-black text-black dark:text-white transition-colors duration-300 min-h-screen font-sans flex flex-col">
                    {/* Toast */}
                    <div id="toast" className={`fixed top-14 left-1/2 -translate-x-1/2 z-[100] bg-white/50 dark:bg-[#2C2C2E]/90 backdrop-blur-md text-black dark:text-white px-6 py-3 rounded-full text-[15px] font-medium shadow-2xl transition-all duration-300 flex items-center gap-2 ${toast.show ? 'opacity-100 translate-y-0 scale-100' : 'opacity-0 -translate-y-4 scale-95 pointer-events-none'}`}>
                        {toast.message}
                    </div>

                    {/* Header */}
                    <div className="sticky top-0 z-40 bg-[#F2F2F7]/80 dark:bg-black/80 backdrop-blur-xl border-b border-black/5 dark:border-white/10 safe-top">
                        <div className="px-5 pt-4 pb-3 flex justify-between items-end">
                            <div>
                                <h1 className="text-[34px] font-bold tracking-tight text-black dark:text-white leading-tight">Trip 2026</h1>
                                <p className="text-[13px] font-medium text-gray-500 dark:text-gray-400 mt-0.5 uppercase tracking-wide">Jan 31 - Feb 19 Â· 19 Days</p>
                            </div>
                            <button onClick={toggleInstallGuide} className="w-8 h-8 rounded-full bg-gray-200/50 dark:bg-white/10 flex items-center justify-center active:scale-90 transition-transform">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#007AFF" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></svg>
                            </button>
                        </div>
                    </div>

                    {/* Main */}
                    <main className="px-4 py-4 max-w-lg mx-auto w-full flex-grow safe-pb-with-margin">
                        {currentTab === 'today' && <RenderToday switchTab={setCurrentTab} />}
                        {currentTab === 'trip' && <RenderTrip expandedDayId={expandedDayId} toggleDay={toggleDay} openWeather={openWeather} />}
                        {currentTab === 'info' && <RenderInfo />}
                        {currentTab === 'guide' && <RenderGuide apiKey={apiKey} toggleApiModal={toggleApiModal} aiData={aiData} isFetching={isFetchingAi} fetchAiGuide={fetchAiGuide} getCurrentCity={getCurrentCity} />}
                    </main>

                    {/* Tab Bar - Adjusted for iPhone 14/17 Pro Max Home Bar */}
                    <div className="fixed left-1/2 -translate-x-1/2 w-[90%] max-w-[380px] h-[64px] bg-white/10 dark:bg-[#1C1C1E]/50 backdrop-blur-xl border border-white/20 dark:border-white/10 shadow-2xl rounded-[32px] p-1.5 flex items-center justify-between z-50 safe-bottom-pos">
                        <TabButton id="today" label="ç¸½è¦½" icon={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></>} currentTab={currentTab} setTab={setCurrentTab} />
                        <TabButton id="trip" label="è¡Œç¨‹" icon={<><path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/><circle cx="12" cy="10" r="3"/></>} currentTab={currentTab} setTab={setCurrentTab} />
                        <TabButton id="info" label="è³‡è¨Š" icon={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></>} currentTab={currentTab} setTab={setCurrentTab} />
                        <TabButton id="guide" label="AI æ”»ç•¥" icon={<><path d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9"/></>} currentTab={currentTab} setTab={setCurrentTab} isAi={true} />
                    </div>

                    {/* Modals */}
                    {showInstallModal && <InstallModal toggle={toggleInstallGuide} />}
                    {showApiModal && <ApiModal toggle={toggleApiModal} onSave={saveApiKeyFunc} />}
                    {weatherModal.visible && <WeatherModal modal={weatherModal} close={closeWeather} />}
                </div>
            );
        }

        // --- Helpers & Sub-Components ---
        function ApiInput({ onSave }) {
            const inputRef = useRef(null);
            return (
                <>
                    <input ref={inputRef} type="password" placeholder="è²¼ä¸Š API Key" className="w-full p-4 rounded-xl bg-gray-100 dark:bg-gray-800 mb-4 outline-none border-2 border-transparent focus:border-[#007AFF] dark:text-white transition-all text-[15px]" />
                    <div className="flex gap-3">
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noreferrer" className="flex-1 py-3.5 text-center rounded-xl bg-gray-100 dark:bg-gray-800 text-[15px] font-semibold text-gray-500 active:scale-95 transition-transform">å–å¾— Key</a>
                        <button onClick={() => onSave(inputRef.current.value)} className="flex-[2] py-3.5 rounded-xl bg-[#007AFF] text-white font-semibold text-[15px] shadow-lg shadow-blue-500/30 active:scale-95 transition-transform">å„²å­˜ä¸¦å•Ÿå‹•</button>
                    </div>
                </>
            );
        }

        function TabButton({ id, label, icon, currentTab, setTab, isAi }) {
            const isActive = currentTab === id;
            let strokeColor = 'currentColor';
            if (isActive) strokeColor = isAi ? '#AF52DE' : '#007AFF';
            return (
                <button onClick={() => setTab(id)} className={`flex-1 h-full rounded-[26px] flex flex-col items-center justify-center gap-1 transition-all duration-300 ${isActive ? 'bg-white dark:bg-[#2C2C2E] shadow-[0_2px_12px_rgba(0,0,0,0.08)]' : 'opacity-40 hover:opacity-60'}`}>
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke={strokeColor} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">{icon}</svg>
                    <span className={`text-[10px] font-semibold tracking-wide ${isActive ? (isAi ? 'text-purple-500' : 'text-[#007AFF] dark:text-[#0A84FF]') : ''}`}>{label}</span>
                </button>
            );
        }

        function RenderToday({ switchTab }) {
            const today = new Date();
            const dateStr = `${today.getMonth() + 1}/${today.getDate()}`;
            const todayData = TRIP.find(d => d.date === dateStr);
            const tripStart = new Date(2026, 0, 31);
            if (todayData) {
                const todayFlight = FLIGHTS.find(f => f.t.startsWith(dateStr));
                const currentHotel = HOTELS.find(h => h.t === todayData.city);
                return (
                    <div className="space-y-6 pb-24">
                        <div className="bg-white dark:bg-[#1C1C1E] rounded-[22px] p-6 shadow-sm text-center relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-[#007AFF] to-[#AF52DE]"></div>
                            <h2 className="text-[13px] font-bold text-gray-400 uppercase tracking-widest mb-1">{todayData.date} Â· {todayData.wk}</h2>
                            <h1 className="text-[42px] font-bold dark:text-white mb-6 tracking-tight">{todayData.city}</h1>
                            <button onClick={() => switchTab('guide')} className="w-full py-3.5 rounded-[14px] bg-gray-50 dark:bg-[#2C2C2E] text-[#AF52DE] text-[15px] font-semibold flex items-center justify-center gap-2 active:bg-gray-100 dark:active:bg-gray-700 transition-colors">âœ¨ æŸ¥çœ‹ä»Šæ—¥ AI æ”»ç•¥<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
                        </div>
                        <WeatherWidget city={todayData.city} />
                        {todayFlight && (
                            <div>
                                <h3 className="ml-4 mb-2 text-[13px] font-semibold text-gray-500 uppercase tracking-wide">ä»Šæ—¥èˆªç­</h3>
                                <div className="bg-[#1C1C1E] text-white rounded-[22px] p-5 shadow-xl relative overflow-hidden">
                                    <div className="flex justify-between items-start mb-6 relative z-10"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-xl">âœˆï¸</div><div><div className="text-[17px] font-bold">{todayFlight.n.split(' ')[0]}</div><div className="text-[13px] text-gray-400 font-medium">{todayFlight.n.split(' ').slice(1).join(' ')}</div></div></div><div className="text-right"><div className="text-[11px] font-bold text-[#30D158] bg-[#30D158]/20 px-2 py-0.5 rounded text-center mb-1">ON TIME</div></div></div>
                                    <div className="flex justify-between items-end relative z-10"><div><div className="text-[13px] text-gray-400 mb-0.5">Time</div><div className="text-[28px] font-medium leading-none">{todayFlight.v}</div></div><div className="text-right"><div className="text-[13px] text-gray-400 mb-0.5">Date</div><div className="text-[17px] font-medium leading-none">{todayFlight.t.split(' Â· ')[0]}</div></div></div>
                                    {todayFlight.u && <a href={todayFlight.u} target="_blank" rel="noreferrer" className="mt-5 block w-full py-3 bg-white text-black text-center rounded-[12px] text-[15px] font-bold hover:bg-gray-100 transition-colors">å‰å¾€å ±åˆ° / æŸ¥çœ‹å‹•æ…‹</a>}
                                </div>
                            </div>
                        )}
                        {currentHotel && (
                            <div>
                                <h3 className="ml-4 mb-2 text-[13px] font-semibold text-gray-500 uppercase tracking-wide">ä½å®¿</h3>
                                <div className="bg-white dark:bg-[#1C1C1E] rounded-[22px] p-5 shadow-sm active:scale-[0.99] transition-transform">
                                    <div className="flex justify-between items-start"><div><div className="text-[17px] font-bold dark:text-white leading-snug">{currentHotel.v}</div><div className="text-[15px] text-gray-500 mt-1">{currentHotel.d}</div><div className="flex gap-3 mt-3"><a href={`https://maps.google.com/?q=${encodeURIComponent(currentHotel.l)}`} target="_blank" rel="noreferrer" className="h-8 px-3 rounded-full bg-blue-50 dark:bg-blue-500/10 text-[#007AFF] text-[13px] font-semibold flex items-center gap-1.5"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>å°èˆª</a>{currentHotel.u && <a href={currentHotel.u} target="_blank" rel="noreferrer" className="h-8 px-3 rounded-full bg-orange-50 dark:bg-orange-500/10 text-orange-500 text-[13px] font-semibold flex items-center gap-1.5">è¨‚å–®è©³æƒ…</a>}</div></div><div className="text-[11px] font-bold bg-gray-100 dark:bg-[#2C2C2E] text-gray-500 dark:text-gray-300 px-2 py-1 rounded-md">{currentHotel.dt}</div></div>
                                </div>
                            </div>
                        )}
                        <div><h3 className="ml-4 mb-2 text-[13px] font-semibold text-gray-500 uppercase tracking-wide">ä»Šæ—¥è¡Œç¨‹</h3><div className="bg-white dark:bg-[#1C1C1E] rounded-[22px] px-2 py-2 shadow-sm">{todayData.tl.map((e, idx) => (<TimelineItem key={idx} e={e} isLast={idx === todayData.tl.length - 1} />))}</div></div>
                    </div>
                );
            } else {
                const diffTime = tripStart - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays > 0 ? (
                    <div className="flex flex-col items-center justify-center h-[70vh] text-center"><div className="w-24 h-24 rounded-full bg-gray-100 dark:bg-[#1C1C1E] flex items-center justify-center text-5xl mb-8 shadow-sm">âœˆï¸</div><h2 className="text-gray-500 dark:text-gray-400 text-[15px] font-medium mb-2">è·é›¢å‡ºç™¼é‚„æœ‰</h2><div className="text-7xl font-bold dark:text-white mb-4 tracking-tighter">{diffDays}<span className="text-2xl font-medium ml-2 text-gray-400">å¤©</span></div><p className="text-[15px] text-gray-400">Jan 31, 2026 Â· Taipei â” Dubai</p></div>
                ) : (
                    <div className="flex flex-col items-center justify-center h-[70vh] text-center opacity-50"><div className="text-5xl mb-4">ğŸ‘‹</div><h2 className="text-2xl font-bold dark:text-white">æ—…ç¨‹å·²çµæŸ</h2><p className="text-[15px] text-gray-500 mt-2">æœŸå¾…ä¸‹ä¸€æ¬¡çš„å†’éšªï¼</p></div>
                );
            }
        }

        function WeatherWidget({ city }) {
            const [data, setData] = useState(null);
            const [error, setError] = useState(false);
            useEffect(() => {
                const coords = CITY_COORDS[city];
                if(!coords) return;
                fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lng}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,is_day&daily=temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=auto`).then(res => res.json()).then(data => setData(data)).catch(() => setError(true));
            }, [city]);
            if (error) return <div className="bg-white dark:bg-[#1C1C1E] rounded-[22px] p-6 text-center text-gray-500">å¤©æ°£è¼‰å…¥å¤±æ•—</div>;
            if (!data) return <div className="bg-white dark:bg-[#1C1C1E] rounded-[22px] p-8 flex justify-center"><div className="animate-spin h-8 w-8 border-4 border-[#007AFF] border-t-transparent rounded-full"></div></div>;
            const current = data.current;
            const daily = data.daily;
            const weather = getWeatherText(current.weather_code, current.is_day === 1);
            return (
                <div className="bg-gradient-to-br from-[#5AC8FA] to-[#007AFF] text-white rounded-[22px] p-6 shadow-lg relative overflow-hidden min-h-[200px]"><div className="flex justify-between items-start mb-8"><div><div className="text-[64px] font-light leading-none tracking-tight">{Math.round(current.temperature_2m)}Â°</div><div className="text-[19px] font-medium opacity-90 mt-1">{weather.text}</div><div className="text-[15px] opacity-75 font-medium mt-1">H:{Math.round(daily.temperature_2m_max[0])}Â° L:{Math.round(daily.temperature_2m_min[0])}Â°</div></div><div className="text-[56px] drop-shadow-md">{weather.icon}</div></div><div className="grid grid-cols-2 gap-3 bg-white/10 rounded-[14px] p-4 backdrop-blur-md border border-white/10"><div className="flex flex-col gap-0.5"><span className="text-[10px] uppercase tracking-wider opacity-70">é«”æ„Ÿæ¿•åº¦</span><span className="text-[17px] font-semibold">{current.relative_humidity_2m}%</span></div><div className="flex flex-col gap-0.5"><span className="text-[10px] uppercase tracking-wider opacity-70">é¢¨é€Ÿ</span><span className="text-[17px] font-semibold">{current.wind_speed_10m} <span className="text-[12px] font-normal">km/h</span></span></div><div className="flex flex-col gap-0.5"><span className="text-[10px] uppercase tracking-wider opacity-70">æ—¥å‡º</span><span className="text-[15px] font-medium">{daily.sunrise[0].split('T')[1]}</span></div><div className="flex flex-col gap-0.5"><span className="text-[10px] uppercase tracking-wider opacity-70">æ—¥è½</span><span className="text-[15px] font-medium">{daily.sunset[0].split('T')[1]}</span></div></div></div>
            );
        }

        function RenderTrip({ expandedDayId, toggleDay, openWeather }) {
            return (
                <div className="space-y-4 pb-24">
                    {TRIP.map(d => (
                        <div key={d.id} className="bg-white dark:bg-[#1C1C1E] rounded-[22px] shadow-sm overflow-hidden transition-all duration-300">
                            <div onClick={() => toggleDay(d.id)} className="active:bg-gray-50 dark:active:bg-[#2C2C2E] transition-colors cursor-pointer p-5 flex justify-between items-center"><div className="flex items-center gap-4"><div className="flex flex-col"><span className="text-[11px] font-bold text-gray-400 uppercase tracking-widest">{d.date} Â· {d.wk}</span><h2 className="text-[22px] font-bold dark:text-white leading-tight">{d.city}</h2></div><button onClick={(e) => openWeather(d.city, e)} className="flex items-center gap-1.5 bg-gray-100 dark:bg-[#2C2C2E] px-3 py-1.5 rounded-full transition-colors hover:bg-gray-200 dark:hover:bg-[#3A3A3C]"><span className="text-[13px]">{getWeatherText(d.c === 'Sunny' ? 0 : d.c === 'Rain' ? 61 : 3, true).icon}</span><span className="text-[13px] font-semibold text-gray-600 dark:text-gray-300">{d.t}</span></button></div><div className={`rotate-icon ${expandedDayId === d.id ? 'open' : ''} w-8 h-8 bg-gray-100 dark:bg-[#2C2C2E] rounded-full flex items-center justify-center text-gray-500`}><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="m9 18 6-6-6-6"/></svg></div></div>
                            <div className={`accordion-content ${expandedDayId === d.id ? 'open' : ''}`}><div className="px-5 pb-5"><div className="border-t border-gray-100 dark:border-gray-800 pt-2">{d.tl.map((e, idx) => (<TimelineItem key={idx} e={e} isLast={idx === d.tl.length - 1} embedMap={true} />))}</div></div></div>
                        </div>
                    ))}
                    <div className="text-center py-8 text-gray-400 text-[13px] font-medium">âœˆï¸ æ—…ç¨‹çµæŸ</div>
                </div>
            );
        }

        function TimelineItem({ e, isLast, embedMap = false }) {
            return (
                <div className="py-5 relative">
                    <div className="flex gap-4"><div className="w-12 shrink-0 text-right pt-1"><span className="text-[13px] font-semibold text-gray-400 tabular-nums">{e.tm}</span></div><div className="flex-1 min-w-0"><div className="flex justify-between items-start"><h4 className={`text-[17px] font-bold leading-snug pr-2 ${e.eat?'text-[#FF9500]':e.imp?'text-[#007AFF]':e.buy?'text-[#AF52DE]':'dark:text-white'}`}>{e.ti}</h4>{e.loc && <a href={`https://maps.google.com/?q=${encodeURIComponent(e.loc)}`} target="_blank" rel="noreferrer" onClick={(ev) => ev.stopPropagation()} className="w-8 h-8 rounded-full bg-blue-50 dark:bg-blue-500/10 flex items-center justify-center shrink-0 text-[#007AFF] hover:bg-blue-100 dark:hover:bg-blue-500/20 transition-colors"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg></a>}</div><p className="text-[15px] text-gray-600 dark:text-gray-300 mt-1.5 leading-relaxed">{e.d}</p>{(e.desc || e.menu || e.tel || e.l || (embedMap && e.loc)) && (<div className="mt-4 bg-gray-50 dark:bg-[#2C2C2E] rounded-[16px] p-3.5 text-[14px] space-y-3 border border-transparent dark:border-white/5">{e.desc && <div className="text-gray-600 dark:text-gray-300 leading-relaxed">{e.desc}</div>}{e.menu && <div className="flex gap-2.5 items-start"><span className="text-[#FF9500] shrink-0 text-[16px]">ğŸ½ï¸</span><span className="text-gray-700 dark:text-gray-200 font-medium">{e.menu}</span></div>}{e.tel && <div className="flex gap-2.5 items-center"><span className="text-[#30D158] shrink-0 text-[16px]">ğŸ“</span><a href={`tel:${e.tel}`} className="text-[#007AFF] font-medium hover:underline">{e.tel}</a></div>}{e.l && <div className="flex flex-wrap gap-2 pt-1">{e.l.map((link, i) => <a key={i} href={link.u} target="_blank" rel="noreferrer" className="text-[13px] px-3 py-1.5 rounded-lg bg-white dark:bg-[#3A3A3C] border border-gray-200 dark:border-transparent dark:text-gray-200 flex items-center gap-1.5 font-medium shadow-sm active:scale-95 transition-all">ğŸ”— {link.t}</a>)}</div>}{embedMap && e.loc && (e.imp || e.eat || e.buy || e.tm.includes(':')) && (<div className="pt-2 rounded-[12px] overflow-hidden"><iframe className="map-frame w-full h-[150px] border-0" loading="lazy" referrerPolicy="no-referrer-when-downgrade" src={`https://maps.google.com/maps?q=${encodeURIComponent(e.loc)}&t=&z=15&ie=UTF8&iwloc=&output=embed`}></iframe></div>)}</div>)}</div></div>{!isLast && <div className="absolute bottom-0 right-0 w-[calc(100%-64px)] h-[0.5px] bg-gray-200 dark:bg-gray-700/50"></div>}
                </div>
            );
        }

        function RenderInfo() {
            return (
                <div className="space-y-8 pb-24">
                    <div><h3 className="ml-4 mb-2 text-[13px] font-semibold text-gray-500 uppercase tracking-wide">èˆªç­è³‡è¨Š</h3><div className="apple-list-group">{FLIGHTS.map((f, i) => (<div key={i} className="apple-list-item px-4 py-4 flex justify-between items-center bg-white dark:bg-[#1C1C1E] active:bg-gray-50 dark:active:bg-[#2C2C2E] transition-colors"><div className="dark:text-white"><div className="text-[16px] font-semibold">{f.t}</div><div className="text-[13px] text-gray-500 mt-0.5">{f.n}</div></div><div className="text-right"><div className="text-[16px] text-gray-900 dark:text-gray-200 font-medium tabular-nums">{f.v}</div>{f.u && <a href={f.u} target="_blank" rel="noreferrer" className="text-[12px] text-[#007AFF] font-medium mt-0.5 inline-block">æŸ¥çœ‹ç‹€æ…‹ â€º</a>}</div></div>))}</div></div>
                    <div><h3 className="ml-4 mb-2 text-[13px] font-semibold text-gray-500 uppercase tracking-wide">ä½å®¿è³‡è¨Š</h3><div className="apple-list-group">{HOTELS.map((h, i) => (<div key={i} className="apple-list-item px-4 py-4 flex justify-between items-start bg-white dark:bg-[#1C1C1E] active:bg-gray-50 dark:active:bg-[#2C2C2E] transition-colors"><div><div className="flex items-center gap-2 mb-1"><div className="text-[16px] font-bold dark:text-white">{h.t}</div><div className="text-[11px] font-bold text-[#007AFF] bg-blue-50 dark:bg-blue-500/20 px-1.5 py-0.5 rounded-md">{h.dt}</div></div><div className="text-[15px] dark:text-gray-200 font-medium">{h.v}</div><div className="text-[13px] text-gray-500 mt-0.5 leading-tight">{h.d}</div><div className="flex items-center gap-3 mt-2"><div className="text-[12px] text-[#FF9500] font-medium">{h.n}</div>{h.u && <a href={h.u} target="_blank" rel="noreferrer" className="text-[12px] text-[#007AFF] font-medium flex items-center gap-1">é è¨‚é€£çµ â€º</a>}</div></div><a href={`https://maps.google.com/?q=${encodeURIComponent(h.l)}`} target="_blank" rel="noreferrer" className="w-8 h-8 rounded-full bg-gray-100 dark:bg-[#2C2C2E] flex items-center justify-center shrink-0 text-[#007AFF]"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg></a></div>))}</div></div>
                </div>
            );
        }

        function RenderGuide({ apiKey, toggleApiModal, aiData, isFetching, fetchAiGuide, getCurrentCity }) {
            const todayStr = new Date().toLocaleDateString();
            const currentCity = getCurrentCity();
            const hasTodayData = aiData && aiData.date === todayStr && aiData.content;
            let guideGeneral = "", guideTransport = "", guideEat = "", guideShopping = "";
            if (hasTodayData) { 
                const parts = aiData.content.split('|||'); 
                guideGeneral = parts[0] || ""; 
                guideTransport = parts[1] || ""; 
                guideEat = parts[2] || "";
                guideShopping = parts[3] || ""; 
            }

            useEffect(() => {
                if(apiKey && !hasTodayData && !isFetching) { const timer = setTimeout(() => fetchAiGuide(currentCity), 500); return () => clearTimeout(timer); }
            }, [apiKey, hasTodayData, isFetching, currentCity]);

            return (
                <div className="pb-24 space-y-6">
                    <div className="flex items-center justify-between px-2 pt-2"><h2 className="text-[28px] font-bold dark:text-white tracking-tight">æ¯æ—¥æ”»ç•¥</h2></div>
                    {!apiKey ? (
                        <div className="bg-white dark:bg-[#1C1C1E] rounded-[22px] p-8 text-center shadow-sm">
                            <h3 className="text-xl font-bold mb-3 dark:text-white">å•Ÿç”¨æ™ºæ…§å°éŠ</h3>
                            <p className="text-gray-500 dark:text-gray-400 text-[15px] mb-8 leading-relaxed">è¼¸å…¥æ‚¨çš„ API Keyï¼Œè®“ AI æ ¹æ“šä»Šæ—¥çš„å…·é«”è¡Œç¨‹ï¼ˆå¦‚ {currentCity} çš„æ™¯é»ï¼‰ï¼Œå³æ™‚ç”Ÿæˆå¤©æ°£ç©¿æ­å»ºè­°ã€äº¤é€šå°ç­–èˆ‡è³¼ç‰©æƒ…å ±ã€‚</p>
                            <button onClick={toggleApiModal} className="w-full bg-[#007AFF] text-white py-3.5 rounded-[14px] font-bold text-[15px] shadow-lg active:scale-95 transition-transform">ç«‹å³å•Ÿç”¨</button>
                        </div>
                    ) : hasTodayData ? (
                        <>
                            <div className="bg-white dark:bg-[#1C1C1E] rounded-[22px] p-6 shadow-sm border border-transparent dark:border-white/5"><div className="flex items-center gap-2 mb-5"><span className="text-[11px] font-bold bg-[#AF52DE]/10 text-[#AF52DE] px-2 py-0.5 rounded">TODAY</span><span className="text-[13px] text-gray-400 font-medium">{todayStr} Â· {currentCity}</span></div><div className="prose dark:prose-invert prose-sm max-w-none prose-p:text-gray-700 dark:prose-p:text-gray-300 prose-headings:text-black dark:prose-headings:text-white leading-7" dangerouslySetInnerHTML={{ __html: marked.parse(guideGeneral) }}></div></div>
                            <div className="bg-white dark:bg-[#1C1C1E] rounded-[22px] p-6 shadow-sm border border-transparent dark:border-white/5"><div className="flex items-center gap-3 mb-4"><div className="w-10 h-10 rounded-full bg-blue-50 dark:bg-blue-500/20 flex items-center justify-center text-xl">ğŸš‚</div><h3 className="text-[17px] font-bold dark:text-white">äº¤é€šæ”»ç•¥</h3></div><div className="prose dark:prose-invert prose-sm max-w-none prose-p:text-gray-700 dark:prose-p:text-gray-300 leading-7" dangerouslySetInnerHTML={{ __html: marked.parse(guideTransport) }}></div></div>
                            <div className="bg-white dark:bg-[#1C1C1E] rounded-[22px] p-6 shadow-sm border border-transparent dark:border-white/5"><div className="flex items-center gap-3 mb-4"><div className="w-10 h-10 rounded-full bg-red-50 dark:bg-red-500/20 flex items-center justify-center text-xl">ğŸ½ï¸</div><h3 className="text-[17px] font-bold dark:text-white">å¿…åƒæ¸…å–®</h3></div><div className="prose dark:prose-invert prose-sm max-w-none prose-p:text-gray-700 dark:prose-p:text-gray-300 leading-7" dangerouslySetInnerHTML={{ __html: marked.parse(guideEat) }}></div></div>
                            <div className="bg-white dark:bg-[#1C1C1E] rounded-[22px] p-6 shadow-sm border border-transparent dark:border-white/5"><div className="flex items-center gap-3 mb-4"><div className="w-10 h-10 rounded-full bg-orange-50 dark:bg-orange-500/20 flex items-center justify-center text-xl">ğŸ›ï¸</div><h3 className="text-[17px] font-bold dark:text-white">å¿…è²·æ¸…å–®</h3></div><div className="prose dark:prose-invert prose-sm max-w-none prose-p:text-gray-700 dark:prose-p:text-gray-300 leading-7" dangerouslySetInnerHTML={{ __html: marked.parse(guideShopping) }}></div></div>
                            <div className="flex justify-end pt-2"><button onClick={() => fetchAiGuide(currentCity, true)} className="text-[13px] text-gray-400 font-medium flex items-center gap-1.5 hover:text-[#AF52DE] transition-colors"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>é‡æ–°ç”Ÿæˆ</button></div>
                        </>
                    ) : (
                        <div id="ai-loading-state" className="bg-white dark:bg-[#1C1C1E] rounded-[22px] p-10 text-center shadow-sm"><div className="animate-spin h-8 w-8 border-4 border-[#AF52DE] border-t-transparent rounded-full mx-auto mb-5"></div><p className="text-gray-500 dark:text-gray-400 text-[15px]">æ­£åœ¨åˆ†æä»Šæ—¥è¡Œç¨‹èˆ‡å¤©æ°£...</p></div>
                    )}
                </div>
            );
        }

        function InstallModal({ toggle }) { return <div className="fixed inset-0 z-[70] flex items-center justify-center px-6 animate-in fade-in"><div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={toggle}></div><div className="relative bg-white dark:bg-[#1C1C1E] p-6 rounded-[24px] max-w-sm w-full shadow-2xl scale-100 transition-transform"><div className="text-center"><div className="text-4xl mb-4">ğŸŒ</div><h3 className="text-xl font-bold mb-2 dark:text-white">å®‰è£åˆ°ä¸»ç•«é¢</h3><p className="text-[15px] text-gray-500 mb-6 leading-relaxed">éš±è—ç¶²å€åˆ—ï¼Œç²å¾—å¦‚åŒåŸç”Ÿ App çš„å…¨è¢å¹•é«”é©—ï¼š</p><ol className="text-left text-[15px] space-y-4 bg-gray-100 dark:bg-gray-800/50 p-5 rounded-xl dark:text-gray-200"><li className="flex gap-3 items-center">1. é»æ“Š Safari ä¸‹æ–¹ <svg className="inline text-[#007AFF]" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></svg> åˆ†äº«</li><li>2. é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</li><li>3. é»æ“Šã€ŒåŠ å…¥ã€</li></ol></div></div></div>; }
        function ApiModal({ toggle, onSave }) { return <div className="fixed inset-0 z-[80] flex items-center justify-center px-6 animate-in fade-in"><div className="absolute inset-0 bg-black/60 backdrop-blur-md" onClick={toggle}></div><div className="relative bg-white dark:bg-[#1C1C1E] p-6 rounded-[24px] max-w-sm w-full shadow-2xl"><h3 className="text-xl font-bold mb-2 dark:text-white">å•Ÿå‹•AIæ”»ç•¥</h3><p className="text-[15px] text-gray-500 mb-6">è«‹è¼¸å…¥ Google Gemini API Key ä»¥å•Ÿç”¨æ¯æ—¥è‡ªå‹•æ”»ç•¥åŠŸèƒ½ã€‚</p><ApiInput onSave={onSave} /></div></div>; }
        function WeatherModal({ modal, close }) { return <div className="fixed inset-0 z-[60] flex items-center justify-center px-6 animate-in fade-in"><div className="absolute inset-0 bg-black/40 backdrop-blur-md" onClick={close}></div><div className="relative w-full max-w-sm rounded-[32px] overflow-hidden shadow-2xl bg-gradient-to-b from-[#4CA2CD] to-[#67B8E6] text-white p-8 scale-100 transition-transform"><button onClick={close} className="absolute top-5 right-5 p-2 bg-white/20 rounded-full hover:bg-white/30 transition-colors"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button><div className="flex flex-col items-center">{modal.loading && <div className="animate-spin h-8 w-8 border-4 border-white border-t-transparent rounded-full mb-4"></div>}{!modal.loading && modal.error && <p>å¤©æ°£è¼‰å…¥å¤±æ•—</p>}{!modal.loading && modal.data && <><h2 className="text-3xl font-semibold mb-2">{modal.city}</h2><div className="text-8xl font-thin mb-1 tracking-tighter">{Math.round(modal.data.current.temperature_2m)}Â°</div><div className="text-xl opacity-90 mb-6 font-medium">{getWeatherText(modal.data.current.weather_code, true).text}</div><div className="flex gap-6 text-xl opacity-90 font-medium"><span>H: {Math.round(modal.data.daily.temperature_2m_max[0])}Â°</span><span>L: {Math.round(modal.data.daily.temperature_2m_min[0])}Â°</span></div></>}</div></div></div>; }
        
        function getWeatherText(code, isDay) {
            if(code === 0) return {icon: isDay?'â˜€ï¸':'ğŸŒ™', text:'æ™´æœ—'};
            if(code <= 3) return {icon: isDay?'â›…':'â˜ï¸', text:'å¤šé›²'};
            if(code <= 48) return {icon:'ğŸŒ«ï¸', text:'èµ·éœ§'};
            if(code <= 67) return {icon:'ğŸŒ§ï¸', text:'é›¨å¤©'};
            if(code <= 77) return {icon:'â„ï¸', text:'ä¸‹é›ª'};
            if(code <= 82) return {icon:'â›ˆï¸', text:'é›·é›¨'};
            return {icon:'ğŸŒ§ï¸', text:'é™£é›¨'};
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


